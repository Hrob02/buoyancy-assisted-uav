name: CI

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

jobs:
  lint:
    name: Lint (ruff + black)
    runs-on: ubuntu-22.04
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - name: Install linters
        run: pip install ruff black isort
      - name: ruff
        run: ruff check ros_ws/src ui
      - name: black
        run: black --check ros_ws/src ui
      - name: isort
        run: isort --check-only ros_ws/src ui

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-22.04
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - name: Install pytest
        run: pip install pytest
      # If your workspace has Python dependencies, uncomment the step below and
      # add a requirements.txt (or requirements-dev.txt) at the repo root:
      #   pip install -r requirements.txt
      # - name: Install workspace dependencies
      #   run: pip install -r requirements.txt
      - name: Run tests
        run: pytest ros_ws/src --ignore=ros_ws/src/uav_interfaces -v

  colcon-build:
    name: colcon build (ROS 2 Humble)
    runs-on: ubuntu-22.04
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - name: Setup ROS 2 Humble
        uses: ros-tooling/setup-ros@v0.7
        with:
          required-ros-distributions: humble
      - name: Install colcon
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-colcon-common-extensions
      - name: colcon build
        run: |
          cd ros_ws
          source /opt/ros/humble/setup.bash
          colcon build --symlink-install
        shell: bash
